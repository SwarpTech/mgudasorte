<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MGU DA SORTE - Pong Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background-color: #25262C;
      color: #fdd760;
      font-family: 'Montserrat', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 110vh;
      text-align: center;
      overflow: auto;
      padding-top: 20px;
    }
    .game-container {
      position: relative;
      width: 800px;
      height: 500px;
      margin-bottom: 20px;
    }
    #gameCanvas, #confeteCanvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    #gameCanvas {
      border: 4px solid #fdd760;
      background-color: #25262C;
      z-index: 1;
    }
    #confeteCanvas {
      pointer-events: none;
      z-index: 2;
    }
    h1 { margin-bottom: 10px; }
    p { margin-bottom: 10px; font-size: 18px; }
    #contadorRebates, #contadorRebatesFase2, #recordRebates {
      font-size: 18px;
      margin-bottom: 15px;
      background-color: #fdd760;
      color: #25262C;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      display: inline-block;
    }
    #contadorRebatesFase2, #recordRebates {
      display: none;
      background-color: #ff6b6b;
    }
    button, #copyCupomBtn {
      padding: 10px 20px;
      background-color: #fdd760;
      color: #25262C;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: none;
      margin-top: 10px;
      width: 80%;
      max-width: 300px;
    }
    .logo { width: 150px; margin-bottom: 15px; }
    #mensagemFinal, #mensagemDerrota { font-size: 20px; margin-top: 20px; }
    #mensagemDerrota { color: red; }
    #cupomFinal {
      display: none;
      font-size: 24px;
      font-weight: bold;
      margin-top: 10px;
      background-color: #fdd760;
      color: #25262C;
      padding: 10px 20px;
      border-radius: 10px;
    }
    .botao-central {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
      background-color: #fdd760;
      color: #25262C;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 18px;
      cursor: pointer;
    }
    #botaoStart { display: block; }
    #botaoAvancar, #botaoNovoJogo { display: none; }
  </style>
</head>
<body>
  <!-- ELEMENTOS DO JOGO -->
  <input id="playerNameInput" type="text" placeholder="Digite seu nome (obrigat√≥rio)" style="position: fixed; top: calc(50% + 70px); left: 50%; transform: translateX(-50%); z-index: 999; padding: 10px; font-size: 16px; border-radius: 8px; border: none; width: 80%; max-width: 300px;" />
  <button id="botaoStart" class="botao-central">START</button>
  <button id="botaoAvancar" class="botao-central">Avan√ßar de Fase</button>
  <button id="botaoNovoJogo" class="botao-central">Novo Jogo</button>

  <img src="logo-mgu1.png" alt="Logo MGU" class="logo">
  <h1>MGU DA SORTE</h1>
  <p>Voc√™ j√° est√° concorrendo ao PS5! Complete a fase para ganhar um presente misterioso.</p>
  <p><strong>Miss√£o:</strong> Rebata a bolinha 10 vezes!</p>
  <p id="contadorRebates">Rebates: 0 / 10</p>
  <p id="contadorRebatesFase2">Rebates: <span id="rebatesAtuais">0</span></p>
  <p id="recordRebates">Recorde: <span id="melhorRebate">0</span></p>

  <div class="game-container" style="margin-bottom: 100px;">
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    <canvas id="confeteCanvas" width="800" height="500"></canvas>
  </div>

  <p id="mensagemFinal" style="display:none; margin-top: 30px;">Parab√©ns! Voc√™ completou a fase! Use o cupom abaixo no site do MeuGameUsado üç±</p>
  <div id="cupomFinal">Cupom: <strong id="cupomCode">SORTEMGU</strong> <span style="cursor:pointer;">üìã</span></div>

  <p id="mensagemDerrota" style="display:none;">Voc√™ perdeu! Tente novamente para garantir seu cupom.</p>
  <button id="botaoReiniciar">Tentar Novamente</button>

  <div id="ranking" style="position: fixed; left: 20px; top: 20px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; color: #fdd760; font-size: 14px; font-family: 'Montserrat', sans-serif; z-index: 9999;">
    <h3 style="margin-bottom: 10px; font-size: 16px;">üèÜ Top Jogadores</h3>
    <ul id="rankingList" style="list-style: none; padding: 0; margin: 0; color: #fdd760; font-size: 14px; font-family: 'Montserrat', sans-serif; display: block; background-color: rgba(255, 255, 255, 0.05); padding: 8px; border-radius: 4px; min-height: 20px;"></ul>
  </div>

  <!-- SCRIPTS DO JOGO -->
  <script>
    let fimDeJogoAtivo = false;
window.onload = function () {
  let playerName = "";

  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const confeteCanvas = document.getElementById("confeteCanvas");
  const confeteCtx = confeteCanvas.getContext("2d");
  const mensagemFinal = document.getElementById("mensagemFinal");
  const mensagemDerrota = document.getElementById("mensagemDerrota");
  const botaoReiniciar = document.getElementById("botaoReiniciar");
  const contadorRebates = document.getElementById("contadorRebates");
  const contadorRebatesFase2 = document.getElementById("contadorRebatesFase2");
  const rebatesAtuais = document.getElementById("rebatesAtuais");
  const recordRebates = document.getElementById("recordRebates");
  const melhorRebate = document.getElementById("melhorRebate");
  const cupomFinal = document.getElementById("cupomFinal");
  const cupomCode = document.getElementById("cupomCode");
  const botaoStart = document.getElementById("botaoStart");
  const botaoAvancar = document.getElementById("botaoAvancar");
  const botaoNovoJogo = document.getElementById("botaoNovoJogo");

  const paddleHeight = 100, paddleWidth = 40, ballRadius = 20, goalRebounds = 10;
  const ballSpeedBase = 5, aumentoVelocidade = 0.05;

  let playerY, aiY, ballX, ballY, ballSpeedX, ballSpeedY;
  let rebounds = 0, gameInterval, mouseMoveHandler, touchMoveHandler;
  let confetes = [], emFase2 = false, velocidadeExtra = 0;
  let recordRebatesValue = parseInt(localStorage.getItem('recordRebatesMGU')) || 0;
  let rebatesFase2 = 0;
  melhorRebate.textContent = recordRebatesValue + " (" + (localStorage.getItem('recordHolderNameMGU') || "-") + ")";

  botaoStart.addEventListener('click', startGame);
  botaoAvancar.addEventListener('click', iniciarFase2);
  botaoNovoJogo.addEventListener('click', reiniciarFase2);
  botaoReiniciar.addEventListener('click', reiniciarJogo);
  document.querySelector('#cupomFinal span').addEventListener('click', copiarCupom);

  function initGame() {
    playerY = canvas.height / 2 - paddleHeight / 2;
    aiY = canvas.height / 2 - paddleHeight / 2;
    ballX = canvas.width / 2;
    ballY = canvas.height / 2;
    velocidadeExtra = 0;
    ballSpeedX = ballSpeedBase * (Math.random() > 0.5 ? 1 : -1);
    ballSpeedY = 3 * (Math.random() > 0.5 ? 1 : -1);
    rebounds = 0;
    rebatesFase2 = 0;
    rebatesAtuais.textContent = "0";
    contadorRebates.textContent = `Rebates: ${rebounds} / ${goalRebounds}`;
    contadorRebatesFase2.style.display = emFase2 ? "inline-block" : "none";
    recordRebates.style.display = emFase2 ? "inline-block" : "none";
    contadorRebates.style.display = emFase2 ? "none" : "inline-block";
    mensagemFinal.style.display = "none";
    mensagemDerrota.style.display = "none";
    cupomFinal.style.display = "none";
    botaoReiniciar.style.display = "none";
    confetes = [];
    confeteCtx.clearRect(0, 0, confeteCanvas.width, confeteCanvas.height);

    if (gameInterval) {
      cancelAnimationFrame(gameInterval);
      gameInterval = null;
    }
    if (mouseMoveHandler) document.removeEventListener('mousemove', mouseMoveHandler);
    if (touchMoveHandler) canvas.removeEventListener('touchmove', touchMoveHandler);

    mouseMoveHandler = e => {
      const rect = canvas.getBoundingClientRect();
      playerY = e.clientY - rect.top - paddleHeight / 2;
      playerY = Math.max(0, Math.min(canvas.height - paddleHeight, playerY));
    };
    touchMoveHandler = e => {
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      playerY = touch.clientY - rect.top - paddleHeight / 2;
      playerY = Math.max(0, Math.min(canvas.height - paddleHeight, playerY));
    };

    if (!fimDeJogoAtivo) document.addEventListener('mousemove', mouseMoveHandler);
    if (!fimDeJogoAtivo) canvas.addEventListener('touchmove', touchMoveHandler);

    draw();
  }

  function drawRect(x, y, w, h, color) {
    ctx.fillStyle = color;
    ctx.fillRect(x, y, w, h);
  }
  function drawVerticalText(text, x, y, color = "#25262C") {
    ctx.save();
    ctx.translate(x + 12, y);
    ctx.rotate(Math.PI / 2);
    ctx.font = "bold 16px Montserrat";
    ctx.fillStyle = color;
    ctx.fillText(text, 0, 0);
    ctx.restore();
  }
  function drawBall(x, y, radius, color) {
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.closePath();
  }
  function draw() {
    drawRect(0, 0, canvas.width, canvas.height, "#25262C");
    drawRect(0, playerY, paddleWidth, paddleHeight, "#fdd760");
    drawVerticalText("VOC√ä", 0, playerY + 10);
    drawRect(canvas.width - paddleWidth, aiY, paddleWidth, paddleHeight, "#fdd760");
    drawBall(ballX, ballY, ballRadius, "#fdd760");
  }

  function update() {
    ballX += ballSpeedX;
    ballY += ballSpeedY;
    let aiCenter = aiY + paddleHeight / 2;
    if (aiCenter < ballY - 35) aiY += 6;
    else if (aiCenter > ballY + 35) aiY -= 6;
    aiY = Math.max(0, Math.min(canvas.height - paddleHeight, aiY));
    if (ballY + ballRadius > canvas.height || ballY - ballRadius < 0) {
  ballSpeedY *= -1;
  ballY = Math.max(ballRadius + 1, Math.min(canvas.height - ballRadius - 1, ballY)); // Evita travamento na borda
}
    if (ballX - ballRadius <= paddleWidth + 2 && ballY + ballRadius >= playerY && ballY - ballRadius <= playerY + paddleHeight) {
      const angle = ((ballY - (playerY + paddleHeight / 2)) / (paddleHeight / 2)) * Math.PI / 4;
      const speed = ballSpeedBase + rebounds * 0.4;
      ballSpeedX = speed * Math.cos(angle);
      ballSpeedY = speed * Math.sin(angle);
      rebounds++;
      contadorRebates.textContent = `Rebates: ${rebounds} / ${goalRebounds}`;
    } else if (ballX - ballRadius < 0) {
      fimDeJogo(false);
      return;
    }
    if (ballX + ballRadius > canvas.width - paddleWidth && ballY + ballRadius >= aiY && ballY - ballRadius <= aiY + paddleHeight) {
      ballSpeedX *= -1;
    } else if (ballX + ballRadius > canvas.width) {
      fimDeJogo(true);
    }
    if (rebounds >= goalRebounds && !emFase2) {
      mensagemFinal.style.display = "block";
      cupomFinal.style.display = "block";
      botaoAvancar.style.display = 'block';
      canvas.style.cursor = 'auto';
      clearInterval(gameInterval);
      document.removeEventListener('mousemove', mouseMoveHandler);
      canvas.removeEventListener('touchmove', touchMoveHandler);
      startConfete();
    }
    draw();
  }

  function fase2Game() {
    if (!emFase2) return;
    velocidadeExtra += aumentoVelocidade;
    ballX += ballSpeedX;
    ballY += ballSpeedY;
    aiY = ballY - paddleHeight / 2;
    aiY = Math.max(0, Math.min(canvas.height - paddleHeight, aiY));
    if (ballY + ballRadius > canvas.height || ballY - ballRadius < 0) {
  ballSpeedY *= -1;
  ballY = Math.max(ballRadius + 1, Math.min(canvas.height - ballRadius - 1, ballY));
}
    if (ballX - ballRadius <= paddleWidth + 2 && ballY + ballRadius >= playerY && ballY - ballRadius <= playerY + paddleHeight) {
      const angle = ((ballY - (playerY + paddleHeight / 2)) / (paddleHeight / 2)) * Math.PI / 4;
      const speed = ballSpeedBase + velocidadeExtra;
      ballSpeedX = speed * Math.cos(angle);
      ballSpeedY = speed * Math.sin(angle);
      rebatesFase2++;
  if (rebatesFase2 > 9999) rebatesFase2 = 9999;
      rebatesAtuais.textContent = rebatesFase2;
      if (rebatesFase2 > recordRebatesValue) {
  recordRebatesValue = rebatesFase2;
  melhorRebate.textContent = recordRebatesValue + " (" + playerName + ")";
  localStorage.setItem('recordRebatesMGU', recordRebatesValue);
  localStorage.setItem('recordHolderNameMGU', playerName);

  // Enviar recorde ao Google Sheets
  fetch("https://script.google.com/macros/s/AKfycbzhR_IHsJeWCSgKoTwmPtEjjQZYZLwbfE1T6N0i07Bl-8pXhG_gKw_lJ7ZILDhHfrOz/exec", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      nome: playerName,
      rebate: rebatesFase2
    })
  }).then(res => {
    console.log("Recorde enviado ao Google Sheets");
    atualizarRanking();
  })
    .catch(err => console.error("Erro ao enviar recorde:", err));
}
    } else if (ballX - ballRadius < 0) {
      fimDeJogo(false);
      return;
    }
    if (ballX + ballRadius > canvas.width - paddleWidth && ballY + ballRadius >= aiY && ballY - ballRadius <= aiY + paddleHeight) {
      ballSpeedX *= -1;
    } else if (ballX + ballRadius > canvas.width) {
      fimDeJogo(true);
    }
    draw();
  }

  function startGame() {
    if (gameInterval) {
      cancelAnimationFrame(gameInterval);
      gameInterval = null;
    }
    fimDeJogoAtivo = false;
    const nameInput = document.getElementById("playerNameInput");
    playerName = nameInput.value.trim();
    if (!playerName) {
      alert("Por favor, digite seu nome antes de come√ßar.");
      return;
    }
    nameInput.style.display = "none";
    botaoStart.style.display = "none";
    canvas.style.cursor = 'none';
    emFase2 = false;
    initGame();
    function gameLoopFase1() {
  if (fimDeJogoAtivo) return;
  update();
  draw();
  gameInterval = requestAnimationFrame(gameLoopFase1);
}
gameLoopFase1();
  }

  function iniciarFase2() {
    if (gameInterval) {
      cancelAnimationFrame(gameInterval);
      gameInterval = null;
    }
    fimDeJogoAtivo = false;
    botaoAvancar.style.display = 'none';
    canvas.style.cursor = 'none';
    emFase2 = true;
    velocidadeExtra = 0;
    mensagemFinal.style.display = 'none';
    mensagemDerrota.style.display = 'none';
    cupomFinal.style.display = 'none';
    contadorRebatesFase2.style.display = "inline-block";
    recordRebates.style.display = "inline-block";
    contadorRebates.style.display = "none";
    rebatesFase2 = 0;
    rebatesAtuais.textContent = "0";
    initGame();
    function gameLoopFase2() {
      if (!emFase2) return;
      fase2Game();
      gameInterval = requestAnimationFrame(gameLoopFase2);
    }
    gameLoopFase2();
  }

  function reiniciarFase2() {
    if (gameInterval) {
      cancelAnimationFrame(gameInterval);
      gameInterval = null;
    }
    fimDeJogoAtivo = false;
    botaoNovoJogo.style.display = 'none';
    canvas.style.cursor = 'none';
    emFase2 = true;
    velocidadeExtra = 0;
    initGame();
    function gameLoopFase2() {
  fase2Game();
  gameInterval = requestAnimationFrame(gameLoopFase2);
}
gameLoopFase2();
  }

  function reiniciarJogo() {
    if (gameInterval) {
      cancelAnimationFrame(gameInterval);
      gameInterval = null;
    }
    fimDeJogoAtivo = false;
    botaoStart.style.display = "none";
    botaoReiniciar.style.display = "none";
    canvas.style.cursor = 'none';
    emFase2 = false;
    initGame();
    function gameLoopFase1() {
      if (fimDeJogoAtivo) return;
  update();
  draw();
  gameInterval = requestAnimationFrame(gameLoopFase1);
}
gameLoopFase1();
  }

  function fimDeJogo(venceu) {
    fimDeJogoAtivo = true;
    if (gameInterval) {
      cancelAnimationFrame(gameInterval);
      gameInterval = null;
    }
    document.removeEventListener('mousemove', mouseMoveHandler);
    canvas.removeEventListener('touchmove', touchMoveHandler);
    canvas.style.cursor = 'auto';
    draw();
    const estavaNaFase2 = emFase2;
    emFase2 = false;
    if (estavaNaFase2) {
      if (venceu) {
        mensagemFinal.textContent = `INCR√çVEL! Voc√™ venceu com ${rebatesFase2} rebatidas! üèÜ`;
        mensagemFinal.style.display = 'block';
        startConfete();
      } else {
        mensagemDerrota.textContent = `Voc√™ fez ${rebatesFase2} rebatidas! Seu recorde: ${recordRebatesValue}`;
        mensagemDerrota.style.display = 'block';
      }
      botaoNovoJogo.style.display = 'block';
    } else {
      if (venceu) {
        mensagemFinal.style.display = "block";
        cupomFinal.style.display = "block";
        botaoAvancar.style.display = 'block';
        startConfete();
      } else {
        mensagemDerrota.style.display = "block";
        botaoReiniciar.classList.add("botao-central");
        botaoReiniciar.style.display = "block";
      }
    }
  }

  function atualizarRanking() {
  console.log("Ranking sendo atualizado...");
  const fakeData = [
    { Nome: "Sandro", Recorde: 34 },
    { Nome: "Jo√£o", Recorde: 28 },
    { Nome: "Maria", Recorde: 23 },
    { Nome: "Luiz", Recorde: 20 },
    { Nome: "Ana", Recorde: 18 },
    { Nome: "Carlos", Recorde: 16 },
    { Nome: "Fernanda", Recorde: 15 },
    { Nome: "Bruno", Recorde: 14 },
    { Nome: "Juliana", Recorde: 13 },
    { Nome: "Pedro", Recorde: 12 }
  ];

  const sorted = fakeData
    .filter(row => row.Nome && !isNaN(row.Recorde))
    .sort((a, b) => b.Recorde - a.Recorde)
    .slice(0, 10);
  console.log("Jogadores encontrados:", sorted);

  const list = document.getElementById("rankingList");
  list.innerHTML = "";

  if (sorted.length === 0) {
    const li = document.createElement("li");
    li.textContent = "Nenhum jogador registrado ainda.";
    
      list.appendChild(li);
  } else {
    sorted.forEach((row, index) => {
      const li = document.createElement("li");
      const destaque = index === 0 ? " üî•" : "";
      li.textContent = `${index + 1}¬∫ ${index === 0 ? 'Campe√£o ' : ''}${row.Nome}: ${row.Recorde} rebatidas${destaque}`;
      list.appendChild(li);
    });
  }

  document.getElementById("ranking").style.display = "block";
}
  atualizarRanking();
  botaoStart.style.display = "block";
};
  </script>
</body>
</html>
